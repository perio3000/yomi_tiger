<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- mapper 경로지정 -->
<mapper namespace="edu.global.ex.mapper.ListMapper">


	<insert id="insertBookList">
		<![CDATA[
			insert into yomi_item (id, title, price, publisher, datetime, contents, authors, thumbnail) 
			values (yomi_item_seq.nextval, #{title}, #{price}, #{publisher}, TO_DATE(#{datetime}, 'YYYY-MM-DD'), #{contents}, #{authors}, #{thumbnail})
		]]>
	</insert>

	<!-- VO객체와 데이터베이스 컬럼을 매핑 -->
	<resultMap id="imageMap" type="ImageVO">
		<id property="id" column="id" /> <!-- id = key (result로 해도 상관없음) -->
		<result property="image" column="image" />
		<result property="image_order" column="image_order" />
		<result property="item_id" column="item_id" />
	</resultMap>

	<resultMap id="itemMap" type="ItemVO">
		<id property="id" column="id" />
		<result property="title" column="title" />
		<result property="price" column="price" />
		<result property="publisher" column="publisher" />
		<result property="datetime" column="datetime" />
		<result property="star" column="star" />
		<result property="stock" column="stock" />
		<result property="contents" column="contents" />
		<result property="authors" column="authors" />
		<result property="translators" column="translators" />
		<result property="status" column="status" />
		<result property="thumbnail" column="thumbnail" />
		<collection property="imageList" resultMap="imageMap"></collection> <!-- 1:N, List 매핑 -->
	</resultMap>   
	
	<!-- 신상품 리스트 -->
	<select id="getNewProductListCount" resultType="int">
		<![CDATA[
		SELECT COUNT(*) FROM yomi_item where datetime >= to_char(add_months(sysdate,-36),'yyyy-mm-dd')
		]]>
		<include refid="criteria"></include>
	</select>
	
	<select id="getNewProductList" resultMap="itemMap">
		<![CDATA[
			SELECT * FROM (
    			SELECT ROWNUM AS RNUM, A.* FROM (
        			SELECT id, TO_CHAR(PRICE, '999,999') as price, title, thumbnail, star, publisher, authors, datetime, status, contents FROM yomi_item 
        			where datetime >= to_char(add_months(sysdate,-36),'yyyy-mm-dd') 
        			]]>
        			<include refid="criteria"></include>
					<![CDATA[
					order by datetime desc
    			) A WHERE ROWNUM <= #{pageNum} * #{amount}
         	) WHERE RNUM > (#{pageNum}-1) * #{amount}
		]]>
	</select>

    <sql id="criteria">
    	<if test="type eq 'T'.toString()">
    		 and title LIKE '%'||#{keyword}||'%' 
    	</if>
    	<if test="type eq 'C'.toString()">
    		 and contents LIKE '%'||#{keyword}||'%' 
    	</if>
    	<if test="type eq 'A'.toString()">
    		 and authors LIKE '%'||#{keyword}||'%' 
    	</if>
    	<if test="type eq 'P'.toString()">
    		 and publisher LIKE '%'||#{keyword}||'%' 
    	</if>
    	<if test="type eq 'all'.toString()">
    		 
    	</if>
    	<if test="type eq 'nat'.toString()">
    		 and status LIKE '%국내%' 
    	</if>
    	<if test="type eq 'int'.toString()">
    		 and status LIKE '%해외%' 
    	</if>
    	<if test="type eq 'ebo'.toString()">
    		 and status LIKE '%ebook%' 
    	</if>
    </sql>
	
</mapper>